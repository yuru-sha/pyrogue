# タスクリスト

このドキュメントは、PyRogue開発プロジェクトのタスク管理を行います。

## 完了済み (Done)

最新のコードベースと最近のコミットから、以下の機能は実装済みです。

- [x] **基本的なゲームフレームワーク**
    - [x] Python + TCODによる基本的なウィンドウ表示
    - [x] ゲームループの実装
    - [x] 状態ベースのゲーム管理（メニュー、ゲーム、ゲームオーバー）
    - [x] ウィンドウリサイズ対応
- [x] **プレイヤーキャラクター**
    - [x] マップ上の移動 (viキー, カーソルキー, テンキー)
    - [x] プレイヤーステータス管理（HP、攻撃力、防御力、レベル、経験値）
    - [x] 満腹度システム
    - [x] レベルアップシステム
- [x] **ダンジョン**
    - [x] オリジナルRogue風の3x3グリッドベース生成
    - [x] 部屋と通路の適切な接続
    - [x] "gone rooms"（通路のみのセル）の実装
    - [x] 秘密の扉の配置
    - [x] 階段（上り・下り）の配置
    - [x] 特別な部屋（宝物庫、実験室など）
- [x] **モンスター**
    - [x] モンスターの配置とスポーン管理
    - [x] モンスターの表現 (A-Z)
    - [x] 基本的なAI（プレイヤーを追跡）
    - [x] 階層に応じたモンスター種類の調整
- [x] **戦闘**
    - [x] ターンベースの戦闘システム
    - [x] パーマデス（永続的な死）システム
    - [x] 装備による攻撃力・防御力ボーナス
    - [x] 経験値獲得システム
- [x] **アイテム**
    - [x] アイテムはすべて識別済み
    - [x] **アイテム拾い機能**
        - [x] 自動アイテム拾い（移動時に自動回収）
        - [x] 手動アイテム拾い（Gキー）
        - [x] インベントリ満杯時の適切な処理
        - [x] スタック可能アイテムの自動スタック処理
    - [x] アイテムの種類（武器、防具、ポーション、巻物、食料、指輪、金貨）
    - [x] アイテムの色分け表示
    - [x] アイテムドロップ機能
- [x] **インベントリ・装備システム**
    - [x] インベントリ画面（iキー）
    - [x] 装備システム（武器、防具、指輪）
    - [x] アイテムの使用（ポーション、巻物、食料）
    - [x] 装備の脱着
    - [x] 装備による能力値ボーナス
- [x] **UI/画面システム**
    - [x] タイトル画面（ASCIIアート付き）
    - [x] ゲームオーバー画面（統計表示付き）
    - [x] メッセージログシステム
    - [x] プレイヤーステータス表示
    - [x] FOV（視界）システム
- [x] **フロア管理システム**
    - [x] 階段での昇降機能
    - [x] 各フロアの状態保存
    - [x] フロア間の移動
    - [x] 探索済みエリアの記録
- [x] **扉システム**
    - [x] 通常の扉（開閉機能）
    - [x] 隠し扉（探索機能）
    - [x] 扉の状態管理
- [x] **セーブ/ロード機能**
    - [x] ゲーム状態の保存（Ctrl+S）
    - [x] ゲーム状態の復元（Ctrl+L）
    - [x] セーブファイルの管理
    - [x] プレイヤー、インベントリ、フロア状態の完全な永続化
- [x] **開発環境**
    - [x] uv による依存関係管理
    - [x] Makefile による開発タスク自動化
    - [x] 型チェック（mypy）
    - [x] フォーマッター（ruff）
    - [x] テスト環境の構築
- [x] **CLIモード対応**
    - [x] CLIエンジン（CLIEngine）によるコマンドライン操作
    - [x] main.pyでの--cliオプション対応
    - [x] CLI用GameScreenの実装
    - [x] **GUIとCLIのコマンド統一化**
        - [x] CommonCommandHandlerクラス（共通コマンド処理）
        - [x] CommandContextインターフェース（実行環境の抽象化）
        - [x] CLICommandContext実装（CLI環境への適用）
        - [x] GUICommandContext実装（GUI環境への対応）
        - [x] 統一コマンドセット（移動・アクション・情報・システム）
        - [x] GameLogicクラスの拡張（handle_use_item、handle_combat等）
        - [x] input_handlers.pyでの共通コマンドハンドラー統合準備
        - [x] キー入力のコマンド変換システム（viキー、矢印キー、アクション対応）
- [x] **アイテム効果の分離・拡張**
    - [x] アイテム効果専用モジュール（effects.py）の導入
    - [x] アイテム効果処理のリファクタリング・拡張
- [x] **UI/インベントリ画面の改善**
    - [x] inventory_screen.pyの機能追加・改善
    - [x] game_screen.pyのUI・操作性向上
- [x] **ドキュメント整備**
    - [x] GEMINI.mdの追加（Gemini CLI連携ガイド）
    - [x] CLAUDE.mdの更新
- [x] **アイテム効果システムの完成**
    - [x] コマンドパターン/戦略パターンによるEffect基底クラス・EffectContext導入
    - [x] 食料効果・満腹度システムの完全実装
    - [x] 巻物効果（識別・テレポート・魔法の地図・光・呪い解除・武器強化・防具強化）全実装
    - [x] 呪いシステム（cursedフラグ、呪われた装備は外せない）
    - [x] 強化システム（enchantmentレベル、装備ボーナス計算）
    - [x] Light効果システム（動的FOV）
    - [x] EffectContextプロトコルのUI統合
- [x] **ステータス異常システム**
    - [x] 毒状態（持続ダメージ、ターン経過で自然回復）
    - [x] 麻痺状態（行動不能、時間経過で回復）
    - [x] 混乱状態（移動方向がランダム化）
    - [x] 状態異常の視覚表示（プレイヤーステータス欄）
    - [x] StatusEffect基底クラスとStatusEffectManager実装
    - [x] プレイヤー・モンスター両方への状態異常適用
- [x] **トラップシステム**
    - [x] 落とし穴（ダメージトラップ）
    - [x] 毒の針（毒状態異常付与）
    - [x] テレポートトラップ（ランダム位置転移）
    - [x] トラップの発見・解除機能（Dキー）
    - [x] 隠しトラップと発見済みトラップの管理
    - [x] ダンジョン生成時の自動トラップ配置
- [x] **魔法システム**
    - [x] MP（マジックポイント）管理システム
    - [x] 呪文詠唱システム（Zキーで魔法メニュー）
    - [x] 魔法書（Spellbook）による習得魔法管理
    - [x] ターゲティングシステム（攻撃魔法用）
    - [x] 具体的な魔法実装：
        - [x] Magic Missile（攻撃魔法、確実命中）
        - [x] Heal（HP回復魔法）
        - [x] Cure Poison（毒状態解除）
        - [x] Poison Bolt（毒状態付与攻撃）
    - [x] MP自然回復システム
    - [x] レベルアップ時のMP増加
- [x] **NPCシステム**
    - [x] Actor基底クラス（Player、Monster、NPCの共通基盤）
    - [x] NPCクラス（友好的・中立的・敵対的な態度管理）
    - [x] NPC種類（商人、警備員、村人、僧侶、魔術師）
    - [x] **NPCダンジョン配置システム**
        - [x] NPCSpawnerクラス（階層に応じたNPC配置管理）
        - [x] 特別な部屋でのNPC配置（商人→宝物庫、僧侶→聖域等）
        - [x] フロアレベル別NPC数調整（深い階層ほど少ない）
        - [x] ダンジョン生成時の自動NPC配置
        - [x] 包括的テストスイート（13個のテストケース）
    - [x] **プレイヤーとNPCの相互作用システム**
        - [x] 対話コマンド（Tキー）による会話開始
        - [x] プレイヤー周囲8方向のNPC検索
        - [x] ゲームエンジンとの統合（DIALOGUE状態管理）
        - [x] NPCの視覚的表示（ゲームマップ上）
    - [x] 会話システム（DialogueManager）
        - [x] 分岐対話システム
        - [x] デフォルト会話データ（商人、警備員、僧侶、魔術師、村人）
        - [x] 会話状態管理
        - [x] NPC種類別対話ID管理
    - [x] 取引システム（TradingManager）
        - [x] アイテム売買機能
        - [x] 価格計算システム
        - [x] 取引実行とエラーハンドリング
    - [x] UI統合
        - [x] 会話画面（DialogueScreen）
        - [x] 取引画面（TradingScreen）
        - [x] キーボード操作対応（T、矢印キー、Enter、Esc）
        - [x] 状態管理とscreen遷移
- [x] **スコアランキングシステム**
    - [x] ScoreManagerクラス（JSON形式でのスコア永続化）
    - [x] プレイヤー統計情報（討伐数、最深階層、ターン数、アイテム使用数）
    - [x] オリジナルRogue風スコア計算（金貨×10 + 経験値×5 + レベル×100 + 討伐×50 + 階層×200）
    - [x] 戦闘・ターン・フロア移動との統合
    - [x] ゲームオーバー・勝利画面での詳細スコア表示
    - [x] data/scores.jsonでのスコアファイル管理
- [x] **呪いシステムの拡張**
    - [x] CursedItemGeneratorクラス（呪われたアイテム専用生成器）
    - [x] マイナス補正値アイテム（-1～-3の攻撃力・防御力ペナルティ）
    - [x] 呪われたアイテム種類（5種類の武器、5種類の防具、4種類の指輪）
    - [x] 視覚的表現（紫色での呪いアイテム表示）
    - [x] 適切なマイナス値表示（ATK -2, DEF -1等）
- [x] **Amulet of Yendor配置システム**
    - [x] AmuletOfYendor専用クラス（専用効果とメッセージ）
    - [x] 最下層（26階）での専用配置
    - [x] has_amuletフラグとプレイヤー統合
    - [x] 地上脱出での勝利条件
    - [x] 勝利時の専用スコア記録
- [x] **アイテム識別システム**
    - [x] ItemIdentificationクラス（識別状態管理）
    - [x] 未識別アイテム表示システム（「緑色のポーション」「'FOO BAR'と書かれた巻物」等）
    - [x] プレイ毎のランダムマッピング（色・文字・材質のランダム割り当て）
    - [x] 使用による自己識別機能
    - [x] 識別の巻物による安全な識別
    - [x] インベントリ画面での識別状態表示
    - [x] Player.identification統合
- [x] **Permadeath（恒久的な死）システム**
    - [x] SaveManagerクラスの拡張（Engine統合）
    - [x] 死亡時のセーブデータ自動削除機能
    - [x] セーブファイル整合性チェック（SHA256チェックサム）
    - [x] 改竄防止機能（チェックサム検証）
    - [x] バックアップファイルからの復旧機能
    - [x] 包括的テストスイート（9個のテストケース）
    - [x] プレイヤー死亡時の自動Permadeath発動
    - [x] 死亡プレイヤーセーブデータのロード拒否

## 進行中 (In Progress)

現在部分的に実装されている機能：

- [x] **アイテム効果システム**
    - [x] アイテム効果のフレームワーク
    - [x] ポーション効果の具体的実装
    - [x] 巻物効果の具体的実装
    - [x] 食料効果の具体的実装
- [ ] **ゲームクリア処理**
    - [x] イェンダーのアミュレット検出
    - [x] 勝利画面の実装
    - [x] エンディングメッセージ
    - [x] 最終スコア表示

## 未実装 (TODO)

*オリジナルRogue（1980年代）との比較分析により特定された不足機能*

### 優先度：最高（ゲーム根幹）
**オリジナルRogueの体験を再現するための最重要機能**
- [x] **アイテム識別システム**
    - [x] 未識別ポーション・巻物の実装（プレイ毎にランダム化）
    - [x] 「緑色のポーション」「'FOO BAR'と書かれた巻物」等の表示
    - [x] 使用による自己識別機能
    - [x] 識別の巻物による安全な識別
    - [x] プレイ開始時のアイテム効果ランダマッピング
- [x] **呪いシステムの拡張**
    - [x] 呪われたアイテムの基本フレームワーク（装備後に外せない）
    - [x] 呪われたアイテムの自動生成（武器・防具・指輪）
    - [x] マイナス補正値（-1の剣等）の実装
    - [x] 呪い解除の巻物による解除機能
- [x] **ゲーム目標の明確化**
    - [x] Amulet of Yendorの概念（check_victory実装済み）
    - [x] 最下層（26F）でのアミュレット配置
    - [x] 地上脱出時の勝利条件
- [x] **Permadeath（恒久的な死）**
    - [x] 死亡時のセーブデータ自動削除
    - [x] セーブファイル暗号化（改竄防止）
- [x] **飢餓システムの強化**
    - [x] 基本飢餓システム（Player.consume_food実装済み）
    - [x] ターン進行時の自動飢餓進行（8ターンごとに減少）
    - [x] 6段階の飢餓レベル（Full/Content/Hungry/Very Hungry/Starving/Dying）
    - [x] 段階的ペナルティシステム（攻撃力・防御力の段階的減少）
    - [x] 満腹時のボーナス効果（HP・MP自然回復）
    - [x] 強化されたダメージシステム（より頻繁で重篤な飢餓ダメージ）
    - [x] 飢餓による能力低下・死亡の重大性向上

### 優先度：高
- [x] **多様なモンスターAI**
    - [x] 基本的な追跡AI
    - [x] アイテム盗取（Leprechaun系）
    - [x] ゴールド盗取（Nymph系）
    - [x] レベル下げ攻撃（Wraith系）
    - [x] モンスター分裂機能
    - [x] 遠距離攻撃（弓攻撃等）
    - [x] 逃走行動パターン
- [x] **スコアランキング機能**
    - [x] 到達階層・所持金・倒したモンスター数による総合スコア
    - [x] ハイスコア記録・表示
    - [x] 死因統計の記録
- [x] **幻覚状態異常**
    - [x] 視覚混乱（モンスター・アイテム表示がランダム文字化）
    - [x] 幻覚ポーション・モンスター攻撃による発症
    - [x] HallucinationEffect状態異常クラス（8ターン継続）
    - [x] GameRendererでの視覚混乱システム（ランダム文字・色変換）
    - [x] HallucinationPotionEffect（幻覚ポーション効果）
    - [x] 精神攻撃モンスター（Dream Eater、Phantom Fungus）
    - [x] CombatManagerでの特殊攻撃効果処理（30%確率発症）
    - [x] 包括的なテストスイート

### 優先度：中
- [x] **コード整理・品質向上**
    - [x] バックアップファイルの整理・削除
    - [x] テスト失敗の修正（幻覚システム関連）
    - [x] コードベースの整理・統一化
    - [x] **GUIとCLI入力処理統一化フレームワーク**
        - [x] input_handlers.pyの共通コマンドハンドラー統合
        - [x] StateManagerでの統一コマンド処理準備
        - [x] キーイベント→コマンド変換システム実装
- [ ] **ダンジョン生成のバリエーション**
    - [x] 基本的な部屋・通路生成
    - [x] **迷路階層（部屋なし、複雑な通路）**
        - [x] MazeBuilderクラス（セルラーオートマタベース迷路生成）
        - [x] DungeonDirector拡張（迷路階層の自動選択）
        - [x] StairsManager拡張（迷路専用階段配置）
        - [x] ValidationManager拡張（迷路専用検証システム）
        - [x] 包括的テストスイート（11個のテストケース）
        - [x] 適切な迷路密度制御（10%-40%の床密度）
        - [x] 階層別迷路確率（7階、13階、19階は必ず迷路）
    - [ ] 孤立部屋群（隠し通路でのみアクセス可能）
    - [ ] 暗い部屋（照明なしでは視界効かない）
- [ ] **さらなるコード品質向上**
    - [ ] 通路生成アルゴリズムの改善
    - [ ] 継続的なリファクタリング
    - [ ] テストカバレッジの向上

### 優先度：低
- [ ] **ゲーム拡張要素**
    - [ ] 複数のダンジョン
    - [ ] キャラクタークラス選択
    - [ ] スキルシステム
- [ ] **コンテンツ追加**
    - [ ] ユニークアイテム/アーティファクト
    - [ ] ボスモンスター
    - [ ] 墓システム（死亡履歴の記録）
- [ ] **UI/UX改善**
    - [ ] キーバインドのカスタマイズ
    - [ ] より詳細なヘルプシステム

## 将来の拡張 (Future Extensions)

**注意**: オリジナルRogue (1980年代) には存在しなかった機能群。現代的なローグライク要素の追加。

### **NPCシステム拡張**
- [x] **基本NPCシステム**（完全実装済み）
    - [x] NPCのダンジョン配置システム
    - [x] プレイヤーとNPCの相互作用システム
    - [x] 会話システム（DialogueManager）
    - [x] 取引システム（TradingManager）
    - [x] UI統合（会話画面・取引画面）
    - [x] 包括的テストスイート
- [ ] **NPCシステム拡張**（将来の機能）
    - [ ] 商人との取引システムの完全統合
    - [ ] より複雑なクエストシステム
    - [ ] NPCの行動パターンとAI
    - [ ] 外部ファイルからの会話データ読み込み

## 技術的な課題

- [ ] **さらなる品質向上**
    - [ ] ドキュメンテーションの充実
    - [ ] 追加のテストケース作成
    - [ ] パフォーマンス最適化

## 現在の開発状況

### 完成度評価（オリジナルRogue基準）

**PyRogueの現状**：
現在のPyRogueは**モダンなローグライクとしては十分機能**していますが、**オリジナルRogueの体験**という観点では、以下の重要な要素が不足しています：

**✅ 実装済みの主要機能**：
- ✅ 完全なゲームループ（メニュー、ゲームプレイ、ゲームオーバー）
- ✅ ダンジョン生成、探索、戦闘システム
- ✅ 包括的なアイテムシステム（装備、ポーション、巻物、食料）
- ✅ ステータス異常システム（毒、麻痺、混乱）
- ✅ トラップシステム（発見、解除、様々なトラップ種類）
- ✅ 魔法システム（MP管理、呪文詠唱、ターゲティング）
- ✅ **完全なNPCシステム**（会話、取引、ダンジョン配置、プレイヤー相互作用）
- ✅ セーブ/ロード機能
- ✅ 完全なUI/UXシステム
- ✅ 本格的な呪いシステム（呪われたアイテム、マイナス補正、呪い解除）
- ✅ 基本的な飢餓システム
- ✅ 完全なアイテム識別システム（未識別表示、プレイ毎ランダム化）
- ✅ スコアランキングシステム（詳細統計、ハイスコア記録）
- ✅ 完全なPermadeathシステム（自動削除、改竄防止、バックアップ復旧）
- ✅ 強化された飢餓システム（6段階レベル、段階的ペナルティ、満腹ボーナス）
- ✅ **完全な多様なモンスターAIシステム**（アイテム盗取、ゴールド盗取、レベル下げ攻撃、分裂、遠距離攻撃、逃走行動）

**✅ オリジナルRogue体験の実現**：
PyRogueは現在、**オリジナルRogueの全主要機能を実装済み**です。

### 開発方針

**✅ 主要機能開発完了**：
PyRogueは現在、**オリジナルRogue (1980年代) の全主要機能を実装済み**であり、**完全に本格的なRogue体験**を提供できる状態です。

**次期開発方向性**：
1. **ダンジョン生成のバリエーション** - より豊富な探索体験
2. **拡張コンテンツ** - 現代的なローグライク要素の追加
3. **ゲームバランス調整** - 新機能による難易度バランスの最適化

PyRogueは現在、**完全に機能する本格的なオリジナルRogue再現**として完成しており、追加開発は拡張要素となります。
