# タスクリスト

このドキュメントは、PyRogue開発プロジェクトのタスク管理を行います。

## 完了済み (Done)

最新のコードベースと最近のコミットから、以下の機能は実装済みです。

- [x] **基本的なゲームフレームワーク**
    - [x] Python + TCODによる基本的なウィンドウ表示
    - [x] ゲームループの実装
    - [x] 状態ベースのゲーム管理（メニュー、ゲーム、ゲームオーバー）
    - [x] ウィンドウリサイズ対応
- [x] **プレイヤーキャラクター**
    - [x] マップ上の移動 (viキー, カーソルキー, テンキー)
    - [x] プレイヤーステータス管理（HP、攻撃力、防御力、レベル、経験値）
    - [x] 満腹度システム
    - [x] レベルアップシステム
- [x] **ダンジョン**
    - [x] オリジナルRogue風の3x3グリッドベース生成
    - [x] 部屋と通路の適切な接続
    - [x] "gone rooms"（通路のみのセル）の実装
    - [x] 秘密の扉の配置
    - [x] 階段（上り・下り）の配置
    - [x] 特別な部屋（宝物庫、実験室など）
- [x] **モンスター**
    - [x] モンスターの配置とスポーン管理
    - [x] モンスターの表現 (A-Z)
    - [x] 基本的なAI（プレイヤーを追跡）
    - [x] 階層に応じたモンスター種類の調整
- [x] **戦闘**
    - [x] ターンベースの戦闘システム
    - [x] パーマデス（永続的な死）システム
    - [x] 装備による攻撃力・防御力ボーナス
    - [x] 経験値獲得システム
- [x] **アイテム**
    - [x] アイテムはすべて識別済み
    - [x] **アイテム拾い機能**
        - [x] 自動アイテム拾い（移動時に自動回収）
        - [x] 手動アイテム拾い（Gキー）
        - [x] インベントリ満杯時の適切な処理
        - [x] スタック可能アイテムの自動スタック処理
    - [x] アイテムの種類（武器、防具、ポーション、巻物、食料、指輪、ワンド、金貨）
    - [x] アイテムの色分け表示
    - [x] アイテムドロップ機能
- [x] **インベントリ・装備システム**
    - [x] インベントリ画面（iキー）
    - [x] 装備システム（武器、防具、指輪）
    - [x] アイテムの使用（ポーション、巻物、食料、ワンド）
    - [x] 装備の脱着
    - [x] 装備による能力値ボーナス
- [x] **UI/画面システム**
    - [x] タイトル画面（ASCIIアート付き）
    - [x] ゲームオーバー画面（統計表示付き）
    - [x] メッセージログシステム
    - [x] プレイヤーステータス表示
    - [x] FOV（視界）システム
- [x] **フロア管理システム**
    - [x] 階段での昇降機能
    - [x] 各フロアの状態保存
    - [x] フロア間の移動
    - [x] 探索済みエリアの記録
- [x] **扉システム**
    - [x] 通常の扉（開閉機能）
    - [x] 隠し扉（探索機能）
    - [x] 扉の状態管理
- [⚠️] **セーブ/ロード機能**（部分的実装・重大な問題有り）
    - [x] ゲーム状態の保存（Ctrl+S）
    - [x] ゲーム状態の復元（Ctrl+L）
    - [x] セーブファイルの管理
    - [⚠️] **重大な問題**：
        - [❌] フロアデータの完全復元（現在はロード時にマップが再生成される）
        - [❌] 装備状態の正確な復元（装備表示の不具合）
        - [❌] プレイヤー位置の正確な復元（壁にめり込み等）
        - [❌] トラップ・モンスター配置の復元
- [x] **開発環境**
    - [x] uv による依存関係管理
    - [x] Makefile による開発タスク自動化
    - [x] 型チェック（mypy）
    - [x] フォーマッター（ruff）
    - [x] テスト環境の構築
- [⚠️] **CLIモード対応**（重大な統合問題有り）
    - [x] CLIエンジン（CLIEngine）によるコマンドライン操作
    - [x] main.pyでの--cliオプション対応
    - [x] CLI用GameScreenの実装
    - [⚠️] **GUIとCLIのコマンド統一化**（設計上の重大な問題）
        - [x] CommonCommandHandlerクラス（共通コマンド処理）
        - [x] CommandContextインターフェース（実行環境の抽象化）
        - [x] CLICommandContext実装（CLI環境への適用）
        - [x] GUICommandContext実装（GUI環境への対応）
        - [x] 統一コマンドセット（移動・アクション・情報・システム）
        - [x] GameLogicクラスの拡張（handle_use_item、handle_combat等）
        - [❌] **重大な問題発見**: 実際にはCLIとGUIで動作が異なる（設計意図と実装の乖離）
        - [❌] **統合の失敗**: セーブ・ロード処理等で完全に別実装が存在
        - [❌] **テストの無効化**: CLIテストが実際のGUI動作を反映していない
    - [x] **デバッグ機能の充実**
        - [x] debug yendor（アミュレット取得コマンド）
        - [x] debug floor <number>（階層テレポートコマンド）
        - [x] debug pos <x> <y>（位置テレポートコマンド）
        - [x] CLIモードでの包括的テスト機能
- [x] **アイテム効果の分離・拡張**
    - [x] アイテム効果専用モジュール（effects.py）の導入
    - [x] アイテム効果処理のリファクタリング・拡張
- [x] **UI/インベントリ画面の改善**
    - [x] inventory_screen.pyの機能追加・改善
    - [x] game_screen.pyのUI・操作性向上
- [x] **ドキュメント整備**
    - [x] GEMINI.mdの追加（Gemini CLI連携ガイド）
    - [x] CLAUDE.mdの更新
- [x] **アイテム効果システムの完成**
    - [x] コマンドパターン/戦略パターンによるEffect基底クラス・EffectContext導入
    - [x] 食料効果・満腹度システムの完全実装
    - [x] 巻物効果（識別・テレポート・魔法の地図・光・呪い解除・武器強化・防具強化）全実装
    - [x] 呪いシステム（cursedフラグ、呪われた装備は外せない）
    - [x] 強化システム（enchantmentレベル、装備ボーナス計算）
    - [x] Light効果システム（動的FOV）
    - [x] EffectContextプロトコルのUI統合
- [x] **ステータス異常システム**
    - [x] 毒状態（持続ダメージ、ターン経過で自然回復）
    - [x] 麻痺状態（行動不能、時間経過で回復）
    - [x] 混乱状態（移動方向がランダム化）
    - [x] 状態異常の視覚表示（プレイヤーステータス欄）
    - [x] StatusEffect基底クラスとStatusEffectManager実装
    - [x] プレイヤー・モンスター両方への状態異常適用
- [x] **トラップシステム**
    - [x] 落とし穴（ダメージトラップ）
    - [x] 毒の針（毒状態異常付与）
    - [x] テレポートトラップ（ランダム位置転移）
    - [x] トラップの発見・解除機能（Dキー）
    - [x] 隠しトラップと発見済みトラップの管理
    - [x] ダンジョン生成時の自動トラップ配置
- [x] **魔法的アイテムシステム**（オリジナルRogue準拠に修正完了）
    - [x] 巻物による魔法効果（識別・テレポート・魔法の地図・光・呪い解除・武器強化・防具強化）
    - [x] ポーション効果（治癒・毒・能力強化等）
    - [x] 指輪効果（能力値修正・特殊効果）
    - [✅] **歴史的正確性修正完了**：
        - [✅] MP（マジックポイント）管理システムの完全削除
        - [✅] 呪文詠唱システム（Zキーで魔法メニュー）の削除
        - [✅] 魔法書（Spellbook）による習得魔法管理システムの削除
        - [✅] プレイヤーの直接魔法使用の完全廃止
        - [✅] オリジナルRogue準拠のワンドシステム実装
            - [✅] `z` = zap a wand in a direction（ワンドを方向に向けて使用）
            - [✅] ワンドアイテムクラスの実装（チャージ管理、効果適用）
            - [✅] ワンド効果システム（Magic Missile、Lightning、Light、Nothing等）
            - [✅] 方向指定システムとワンド効果処理（完了）
            - [✅] ワンドスポーン機能（ItemSpawner統合、階層別出現）
- [✅] **NPCシステム**（削除完了 - オリジナルRogueに存在しない）
    - [✅] Actor基底クラス（Player、MonsterのみにPlayer、Monsterの共通基盤に簡素化）
    - [✅] NPCクラス（削除済み）
    - [✅] NPC種類（削除済み）
    - [✅] **NPCダンジョン配置システム**（削除済み）
        - [✅] NPCSpawnerクラス（削除済み）
        - [✅] 特別な部屋でのNPC配置（削除済み）
        - [✅] フロアレベル別NPC数調整（削除済み）
        - [✅] ダンジョン生成時の自動NPC配置（削除済み）
        - [✅] 包括的テストスイート（削除済み）
    - [✅] **プレイヤーとNPCの相互作用システム**（削除済み）
        - [✅] 対話コマンド（Tキー）による会話開始（削除済み、tキーは投げるコマンド用に解放）
        - [✅] プレイヤー周囲8方向のNPC検索（削除済み）
        - [✅] ゲームエンジンとの統合（DIALOGUE状態管理）（削除済み）
        - [✅] NPCの視覚的表示（ゲームマップ上）（削除済み）
    - [✅] 会話システム（DialogueManager）（削除済み）
        - [✅] 分岐対話システム（削除済み）
        - [✅] デフォルト会話データ（削除済み）
        - [✅] 会話状態管理（削除済み）
        - [✅] NPC種類別対話ID管理（削除済み）
    - [✅] 取引システム（TradingManager）（削除済み）
        - [✅] アイテム売買機能（削除済み）
        - [✅] 価格計算システム（削除済み）
        - [✅] 取引実行とエラーハンドリング（削除済み）
    - [✅] UI統合（削除済み）
        - [✅] 会話画面（DialogueScreen）（削除済み）
        - [✅] 取引画面（TradingScreen）（削除済み）
        - [✅] キーボード操作対応（削除済み）
        - [✅] 状態管理とscreen遷移（削除済み）
- [x] **スコアランキングシステム**
    - [x] ScoreManagerクラス（JSON形式でのスコア永続化）
    - [x] プレイヤー統計情報（討伐数、最深階層、ターン数、アイテム使用数）
    - [x] オリジナルRogue風スコア計算（金貨×10 + 経験値×5 + レベル×100 + 討伐×50 + 階層×200）
    - [x] 戦闘・ターン・フロア移動との統合
    - [x] ゲームオーバー・勝利画面での詳細スコア表示
    - [x] scores.jsonでのスコアファイル管理
- [x] **呪いシステムの拡張**
    - [x] CursedItemGeneratorクラス（呪われたアイテム専用生成器）
    - [x] マイナス補正値アイテム（-1～-3の攻撃力・防御力ペナルティ）
    - [x] 呪われたアイテム種類（5種類の武器、5種類の防具、4種類の指輪）
    - [x] 視覚的表現（紫色での呪いアイテム表示）
    - [x] 適切なマイナス値表示（ATK -2, DEF -1等）
- [x] **Amulet of Yendor配置システム**
    - [x] AmuletOfYendor専用クラス（専用効果とメッセージ）
    - [x] 最下層（26階）での専用配置
    - [x] has_amuletフラグとプレイヤー統合
    - [x] 地上脱出での勝利条件
    - [x] 勝利時の専用スコア記録
    - [x] **イェンダー取得時の動的脱出階段生成システム**
        - [x] B1Fに脱出階段の動的生成機能
        - [x] プレイヤーへの自動テレポート機能
        - [x] CLIエンジンでの勝利判定実装
        - [x] オリジナルRogue準拠の勝利フロー完成
- [x] **アイテム識別システム**
    - [x] ItemIdentificationクラス（識別状態管理）
    - [x] 未識別アイテム表示システム（「緑色のポーション」「'FOO BAR'と書かれた巻物」等）
    - [x] プレイ毎のランダムマッピング（色・文字・材質のランダム割り当て）
    - [x] 使用による自己識別機能
    - [x] 識別の巻物による安全な識別
    - [x] インベントリ画面での識別状態表示
    - [x] Player.identification統合
- [x] **Permadeath（恒久的な死）システム**
    - [x] SaveManagerクラスの拡張（Engine統合）
    - [x] 死亡時のセーブデータ自動削除機能
    - [x] セーブファイル整合性チェック（SHA256チェックサム）
    - [x] 改竄防止機能（チェックサム検証）
    - [x] バックアップファイルからの復旧機能
    - [x] 包括的テストスイート（9個のテストケース）
    - [x] プレイヤー死亡時の自動Permadeath発動
    - [x] 死亡プレイヤーセーブデータのロード拒否
- [x] **ゲームクリア処理**
    - [x] イェンダーのアミュレット検出
    - [x] 勝利画面の実装
    - [x] エンディングメッセージ
    - [x] 最終スコア表示
    - [x] 完全な勝利フロー実装

## 進行中 (In Progress)

現在部分的に実装されている機能：

- [✅] **CLI/GUI統合システム**（完全修正済み）
    - [✅] CommonCommandHandlerの基本フレームワーク
    - [✅] CLI/GUI間の実際の動作統一（save_load_managerの完全シリアライズ処理をcommand_handlerに移植）
    - [✅] セーブ・ロード処理の完全統一（GUIもCommonCommandHandler経由に統一）
    - [✅] 統合テストの実効性（CLIテストにセーブ・ロード統合テスト追加、25/25テスト成功）
    - [✅] save_load_manager.pyの削除（統合完了により不要）

- [✅] **セーブ/ロード機能**（完全修正済み）
    - [✅] 基本的なセーブ・ロード機能（Ctrl+S/Ctrl+L）
    - [✅] フロアデータの完全復元（完全なシリアライズ処理による復元）
    - [✅] 装備状態の正確な復元（インベントリ統合処理）
    - [✅] プレイヤー位置の正確な復元（位置・ステータス・アミュレット状態）
    - [✅] エンティティ配置の復元（モンスター・アイテム・トラップの完全復元）

- [✅] **歴史的正確性修正: 魔法システム**（完了）
    - [✅] 既存魔法システム（MP、呪文詠唱、Zキー魔法メニュー）の削除
    - [✅] ワンドアイテムクラスの実装（チャージ管理、効果適用）
    - [✅] ワンド効果システムの実装（Magic Missile、Lightning、Light、Nothing等）
    - [✅] Zキーの動作変更（魔法メニュー → ワンド使用）
    - [✅] 方向指定システムの実装（完了）
- [✅] **基本ローグライクコマンド**（完了）
    - [x] ヘルプ表示（?キー）
    - [x] 休憩（.キー）
    - [x] 調査・検査（xキー）
    - [x] 長時間休憩（Rキー）
    - [x] 走る（Shift+移動キー）
- [✅] **装備システム**（完了）
    - [x] 基本的な装備システム
    - [x] 装備表示の正確性
    - [x] 装備ドロップ時の装備解除処理
    - [x] 装備状態の一貫性確保

## 🚨 緊急修正が必要な問題 (Critical Issues)

**現在動作しているが重大な問題を抱えている機能**

### 最優先（ゲーム体験に直接影響）
- [✅] **🚨アーキテクチャの根本的問題: CLI/GUI統合化の失敗**（完全修正済み）
    - [✅] **問題の核心**: 同じコマンドハンドラーを使用しているはずなのに、CLIとGUIで動作が異なる（修正済み）
    - [✅] **具体的な問題**:
        - [✅] セーブ・ロード処理がCLIとGUIで完全に別実装（統一済み）
        - [✅] CLIテストが実際のGUI動作を反映していない（修正済み）
        - [✅] 統合テストが無意味化している（修正済み）
    - [✅] **必要な修正**:
        - [✅] CommonCommandHandlerの完全統合（完了）
        - [✅] セーブ・ロード処理の完全統一（完了）
        - [✅] CLIとGUIの動作の完全一致の実現（完了）
        - [✅] 統合テストの実効性確保（CLIテスト25/25成功）

- [✅] **セーブ/ロード機能の完全化**（完全修正済み）
    - [✅] フロアデータの完全復元システム（完全なシリアライズ処理による実装）
    - [✅] 装備状態の正確な復元（インベントリ統合処理）
    - [✅] プレイヤー位置の正確な復元（位置・ステータス・アミュレット状態）
    - [✅] エンティティ配置の復元（モンスター・アイテム・トラップの完全復元）

- [✅] **装備システムの動作不具合修正**（完了）
    - [x] 装備アイテムドロップ時の装備解除処理修正
    - [x] 装備表示の正確性向上
    - [x] 装備状態の一貫性確保

### 高優先（ユーザビリティに影響）
- [✅] **基本ローグライクコマンドの完全実装**（完了）
    - [x] 調査・検査コマンド（xキー）
    - [x] 長時間休憩コマンド（Rキー）
    - [x] 走るコマンド（Shift+移動キー）
    - [x] シンボル説明コマンド（/キー）

## 未実装 (TODO)

*オリジナルRogue（1980年代）との比較分析により特定された不足機能*

### 優先度：最高（ゲーム根幹）
**オリジナルRogueの体験を再現するための最重要機能**

- [x] **🚨バグ修正: アイテム識別システム迂回**（修正済み）
    - [x] MovementManager._check_item_pickup()の修正
    - [x] `item.name` → `item.get_display_name(identification)` への変更
    - [x] 未識別アイテムの移動時通知が正しく表示されるよう修正
- [🔄] **🚨歴史的正確性修正: 魔法システム**（大部分完了）
    - [✅] 現在の魔法システム（MP、呪文詠唱、Zキー魔法メニュー）の削除・無効化
    - [🔄] オリジナルRogue準拠のワンドシステム実装
        - [✅] `z` = zap a wand in a direction（ワンドを方向に向けて使用）
        - [✅] ワンドアイテムの実装（Magic Missile、Lightning、Light、Nothing等）
        - [🔄] 方向指定システムとワンド効果処理（実装中）
    - [✅] 魔法的効果をアイテム経由のみに限定
        - [✅] ワンド、巻物、ポーション、指輪による魔法効果
        - [✅] プレイヤーの直接魔法使用の完全廃止
- [x] **アイテム識別システム**
    - [x] 未識別ポーション・巻物の実装（プレイ毎にランダム化）
    - [x] 「緑色のポーション」「'FOO BAR'と書かれた巻物」等の表示
    - [x] 使用による自己識別機能
    - [x] 識別の巻物による安全な識別
    - [x] プレイ開始時のアイテム効果ランダマッピング
- [x] **呪いシステムの拡張**
    - [x] 呪われたアイテムの基本フレームワーク（装備後に外せない）
    - [x] 呪われたアイテムの自動生成（武器・防具・指輪）
    - [x] マイナス補正値（-1の剣等）の実装
    - [x] 呪い解除の巻物による解除機能
- [x] **ゲーム目標の明確化**
    - [x] Amulet of Yendorの概念（check_victory実装済み）
    - [x] 最下層（26F）でのアミュレット配置
    - [x] 地上脱出時の勝利条件
    - [x] B1F脱出階段の動的生成（イェンダー取得時）
    - [x] 完全なオリジナルRogue勝利フロー実装
- [x] **Permadeath（恒久的な死）**
    - [x] 死亡時のセーブデータ自動削除
    - [x] セーブファイル暗号化（改竄防止）
- [x] **飢餓システムの強化**
    - [x] 基本飢餓システム（Player.consume_food実装済み）
    - [x] ターン進行時の自動飢餓進行（8ターンごとに減少）
    - [x] 6段階の飢餓レベル（Full/Content/Hungry/Very Hungry/Starving/Dying）
    - [x] 段階的ペナルティシステム（攻撃力・防御力の段階的減少）
    - [x] 満腹時のボーナス効果（HP・MP自然回復）
    - [x] 強化されたダメージシステム（より頻繁で重篤な飢餓ダメージ）
    - [x] 飢餓による能力低下・死亡の重大性向上

### 優先度：高
- [x] **多様なモンスターAI**
    - [x] 基本的な追跡AI
    - [x] アイテム盗取（Leprechaun系）
    - [x] ゴールド盗取（Nymph系）
    - [x] レベル下げ攻撃（Wraith系）
    - [x] モンスター分裂機能
    - [x] 遠距離攻撃（弓攻撃等）
    - [x] 逃走行動パターン
- [x] **スコアランキング機能**
    - [x] 到達階層・所持金・倒したモンスター数による総合スコア
    - [x] ハイスコア記録・表示
    - [x] 死因統計の記録
- [x] **幻覚状態異常**
    - [x] 視覚混乱（モンスター・アイテム表示がランダム文字化）
    - [x] 幻覚ポーション・モンスター攻撃による発症
    - [x] HallucinationEffect状態異常クラス（8ターン継続）
    - [x] GameRendererでの視覚混乱システム（ランダム文字・色変換）
    - [x] HallucinationPotionEffect（幻覚ポーション効果）
    - [x] 精神攻撃モンスター（Dream Eater、Phantom Fungus）
    - [x] CombatManagerでの特殊攻撃効果処理（30%確率発症）
    - [x] 包括的なテストスイート

### 優先度：中
- [ ] **🎯戦術・UI拡張コマンド実装**
    - [ ] **自動探索コマンド（Oキー）**
        - [ ] 未探索エリアへの自動移動・探索
        - [ ] 安全ルート検索とアイテム回収
        - [ ] 敵発見時の自動停止機能
        - [ ] 既存o（ドア開放）との競合解決
    - [ ] **アイテム識別状況表示（\キー）**
        - [ ] 発見済みアイテムの一覧表示
        - [ ] 識別・未識別状況の確認
        - [ ] ゲーム進行状況の把握支援
    - [ ] **最後のメッセージ表示（Ctrl+Rキー）**
        - [ ] 見逃したメッセージの再表示
        - [ ] メッセージ履歴のスクロール機能
        - [ ] 重要情報の見落とし防止
    - [ ] **投げるコマンド（tキー）**
        - [ ] アイテム投擲による遠距離攻撃
        - [ ] 投擲可能アイテムの判定（ダガー、槍、ポーション等）
        - [ ] 軌道計算とダメージ処理
        - [x] NPCキー（tキー）の再配置が必要 → **NPCシステム削除により解決済み**
    - [ ] **足元・周囲調査コマンド（lキー：GUIモード）**
        - [ ] カーソルで任意地点の調査
        - [ ] アイテム・モンスター・地形の詳細表示
        - [ ] プレイヤー足元のアイテム確認機能
    - [ ] **直接装備コマンド（wキー）**
        - [ ] メイン画面から直接装備操作
        - [ ] インベントリ経由不要の効率化
        - [ ] 装備スロット選択UI
    - [ ] **キャラクター詳細表示（@キー）**
        - [ ] ステータス・装備状況の詳細表示
        - [ ] 能力値変化の履歴表示
        - [ ] プレイヤー情報管理の向上
- [ ] **🔧システム機能修正・追加**
    - [ ] **オートセーブ機能の実装確認**
        - [ ] 環境変数連携の修正
        - [ ] 自動保存タイミングの設定
        - [ ] セーブファイル生成確認
    - [ ] **キー配置整理**
        - [ ] tキーコンフリクト解決（投げる vs NPC対話）
        - [ ] NPCキーを別キー（例：T）に移動
        - [ ] ヘルプ画面の更新
- [x] **コード整理・品質向上**
    - [x] バックアップファイルの整理・削除
    - [x] テスト失敗の修正（幻覚システム関連）
    - [x] コードベースの整理・統一化
    - [x] **GUIとCLI入力処理統一化フレームワーク**
        - [x] input_handlers.pyの共通コマンドハンドラー統合
        - [x] StateManagerでの統一コマンド処理準備
        - [x] キーイベント→コマンド変換システム実装
    - [x] **品質保証プロセスの確立**
        - [x] CLI統合テストの完全実装（19シナリオ100%成功）
        - [x] Pre-commitフックによる自動品質チェック
        - [x] 開発タスク別QAワークフロー（qa-after-refactor, qa-after-feature）
        - [x] 包括的品質保証ドキュメント作成
- [ ] **ダンジョン生成のバリエーション**
    - [x] 基本的な部屋・通路生成
    - [x] **迷路階層（部屋なし、複雑な通路）**
        - [x] MazeBuilderクラス（セルラーオートマタベース迷路生成）
        - [x] DungeonDirector拡張（迷路階層の自動選択）
        - [x] StairsManager拡張（迷路専用階段配置）
        - [x] ValidationManager拡張（迷路専用検証システム）
        - [x] 包括的テストスイート（11個のテストケース）
        - [x] 適切な迷路密度制御（10%-40%の床密度）
        - [x] 階層別迷路確率（7階、13階、19階は必ず迷路）
        - [x] 迷路階層でのアイテムスポーン修正（rooms空リスト対応）
    - [x] **孤立部屋群（隠し通路でのみアクセス可能）**【完全実装済み】
        - [x] IsolatedRoomBuilderクラス（孤立部屋生成システム）
        - [x] 隠し通路による接続システム（SecretDoor使用）
        - [x] 特定階層での自動生成（4階、8階、11階、15階、18階、22階、25階）
        - [x] 包括的テストスイート（test_isolated_room_integration.py）
        - [x] 孤立度パラメータによる発見難易度調整
        - [x] メインダンジョンからの完全分離とアクセス制御
    - [x] **暗い部屋（照明なしでは視界効かない）**【完全実装済み】
        - [x] DarkRoomBuilderクラス（暗い部屋生成システム）
        - [x] 光源アイテムシステム（たいまつ、ランタン、光る指輪）
        - [x] FOVシステムとの完全統合（動的視界制御）
        - [x] 特定階層での自動生成（6階、10階、14階、17階、20階、23階、24階）
        - [x] 包括的テストスイート（test_dark_room_integration.py）
        - [x] 暗さレベル調整システム（darkness_level）
        - [x] 光源による視界範囲動的変更
- [ ] **さらなるコード品質向上**
    - [ ] 通路生成アルゴリズムの改善
    - [ ] 継続的なリファクタリング
    - [ ] テストカバレッジの向上

### 優先度：低
- [ ] **🎮高度なゲームプレイ機能**
    - [ ] **繰り返しコマンド（数字プレフィックス）**
        - [ ] `23s`で23回探索、`5h`で左に5回移動など
        - [ ] 入力処理システムの大幅な変更が必要
        - [ ] オリジナルRogue・NetHack等での標準機能
        - [ ] 効率的なプレイスタイル支援
    - [ ] **キックコマンド（^キー）**
        - [ ] ドアを蹴破る機能
        - [ ] モンスターへのキック攻撃
        - [ ] 特殊な戦術オプション追加
- [ ] **🧪品質保証・ドキュメント整備**
    - [ ] **セーブ・ロード機能のテスト強化**
        - [ ] 修正後のメソッド名での動作確認
        - [ ] セーブファイル作成・読み込みテストケース
        - [ ] Permadeath機能との統合テスト
    - [ ] **新コマンドのドキュメント更新**
        - [ ] README.md操作方法セクションの更新
        - [ ] CLAUDE.md操作説明の追加
        - [ ] ヘルプシステムの拡張
    - [ ] **コマンド統合テストの追加**
        - [ ] CLI統合テストへの新コマンド追加
        - [ ] 休憩・走る・投げるコマンドのテストシナリオ
        - [ ] エッジケースのテストカバレッジ向上
- [ ] **ゲーム拡張要素**
    - [ ] 複数のダンジョン
    - [ ] キャラクタークラス選択
    - [ ] スキルシステム
- [ ] **コンテンツ追加**
    - [ ] ユニークアイテム/アーティファクト
    - [ ] ボスモンスター
    - [ ] 墓システム（死亡履歴の記録）
- [ ] **UI/UX改善**
    - [ ] キーバインドのカスタマイズ
    - [ ] より詳細なヘルプシステム

## 将来の拡張 (Future Extensions)

**注意**: オリジナルRogue (1980年代) には存在しなかった機能群。現代的なローグライク要素の追加。

### **NPCシステム拡張**
- [🗑️] **基本NPCシステム**（削除予定 - オリジナルRogueに存在しない）
    - [🗑️] NPCのダンジョン配置システム
    - [🗑️] プレイヤーとNPCの相互作用システム
    - [🗑️] 会話システム（DialogueManager）
    - [🗑️] 取引システム（TradingManager）
    - [🗑️] UI統合（会話画面・取引画面）
    - [🗑️] 包括的テストスイート
- [🗑️] **NPCシステム拡張**（削除予定 - オリジナルRogueに存在しない）
    - [🗑️] 商人との取引システムの完全統合
    - [🗑️] より複雑なクエストシステム
    - [🗑️] NPCの行動パターンとAI
    - [🗑️] 外部ファイルからの会話データ読み込み

## 技術的な課題

- [ ] **さらなる品質向上**
    - [ ] ドキュメンテーションの充実
    - [ ] 追加のテストケース作成
    - [ ] パフォーマンス最適化

## 現在の開発状況

### 完成度評価（オリジナルRogue基準）

**PyRogueの現状**：
現在のPyRogueは**モダンなローグライクとしては十分機能**していますが、**オリジナルRogueの体験**という観点では、以下の重要な要素が不足しています：

**✅ 実装済みの主要機能**：
- ✅ 完全なゲームループ（メニュー、ゲームプレイ、ゲームオーバー）
- ✅ ダンジョン生成、探索、戦闘システム
- ✅ 包括的なアイテムシステム（装備、ポーション、巻物、食料）
- ✅ ステータス異常システム（毒、麻痺、混乱）
- ✅ トラップシステム（発見、解除、様々なトラップ種類）
- 🗑️ **NPCシステム**（削除完了 - オリジナルRogueに存在しない）
- ✅ 完全なUI/UXシステム
- ✅ 本格的な呪いシステム（呪われたアイテム、マイナス補正、呪い解除）
- ✅ 基本的な飢餓システム
- ✅ 完全なアイテム識別システム（未識別表示、プレイ毎ランダム化）
- ✅ スコアランキングシステム（詳細統計、ハイスコア記録）
- ✅ 完全なPermadeathシステム（自動削除、改竄防止、バックアップ復旧）
- ✅ 強化された飢餓システム（6段階レベル、段階的ペナルティ、満腹ボーナス）
- ✅ **完全な多様なモンスターAIシステム**（アイテム盗取、ゴールド盗取、レベル下げ攻撃、分裂、遠距離攻撃、逃走行動）
- ✅ **オリジナルRogue準拠の魔法システム**（ワンドシステム、チャージ管理、方向指定攻撃）

**⚠️ 部分的実装・問題のある機能**：
- ⚠️ **基本ローグライクコマンド**（一部実装済み）
    - ✅ ヘルプ表示（?キー）、休憩（.キー）
    - ❌ 調査・検査（xキー）、シンボル説明（/キー）
    - ❌ 長時間休憩（Rキー）、走る（Shift+移動キー）
- 🔄 **歴史的正確性修正: 魔法システム**（大部分完了）
    - ✅ 既存魔法システム（MP、呪文詠唱、Zキー魔法メニュー）の削除
    - ✅ ワンドアイテムクラスの実装（チャージ管理、効果適用）
    - ✅ ワンド効果システムの実装（Magic Missile、Lightning、Light、Nothing等）
    - ✅ Zキーの動作変更（魔法メニュー → ワンド使用）
    - 🔄 方向指定システムの実装（実装中）

**⚠️ 現在の開発状況の評価**：
PyRogueは**基本的なローグライクゲームとしては機能**していますが、**オリジナルRogueの完全な体験**という観点では、まだ重要な問題が残っています。

### 開発方針

**🚨 緊急修正が必要な問題**：
1. **CLI/GUI統合システムの根本的修正** - 最重要課題
   - 設計意図と実装の乖離問題
   - セーブ・ロード処理の完全統一
   - 統合テストの実効性確保
2. **セーブ/ロード機能の完全化** - ゲーム体験の基盤
   - フロアデータの完全復元システム
   - 装備・位置・エンティティ配置の正確な復元
3. **基本ローグライクコマンドの完全実装** - ユーザビリティの向上
   - 調査・検査コマンド（xキー）
   - 長時間休憩コマンド（Rキー）
   - 走るコマンド（Shift+移動キー）
4. **オリジナルRogue歴史的正確性の向上** - 魔法システムの修正

**次期開発方向性**：
1. **アーキテクチャの根本的修正** - CLI/GUI統合システムの再設計
2. **重大バグの修正** - セーブ/ロード機能の完全化
3. **基本機能の完成** - 標準的なローグライクコマンドの実装
4. **品質保証システムの再構築** - 実効性のある統合テストの実現

### 問題の根本原因

**CLI/GUI統合の失敗**：
- 設計時には統一されたコマンド処理システムを想定していた
- 実装時に、特にセーブ・ロード機能で完全に別の実装が作成された
- 結果として、CLIテストが実際のGUI動作を反映しない無意味な状態となった
- 統合テストの成功が、実際のGUI機能の正常動作を保証していない

**設計と実装の乖離**：
- CommonCommandHandlerが作成されたにも関わらず、実際の重要機能（セーブ・ロード等）で使用されていない
- CLI/GUI間で動作が異なるため、テストの意味が失われている
- 品質保証システムが機能していない

## 🚀 実装完了計画 (Implementation Roadmap)

### 現実的な修正スケジュール

**Phase 1: 緊急修正（推定: 2-3日）**
- [✅] **Day 1**: オリジナルRogue準拠の簡素化 + CLI/GUI統合修正
  - [✅] 🗑️ **NPCシステムの完全削除**（オリジナルRogueに存在しない）
    - [✅] NPCクラス・NPCSpawner・DialogueManager・TradingManagerの削除
    - [✅] NPC関連UI（対話画面・取引画面）の削除
    - [✅] NPC関連テストの削除
    - [✅] tキー（対話）の無効化、投げるコマンド用に解放
  - [✅] SaveLoadManagerをCommonCommandHandlerから呼び出すように修正
  - [✅] CLI/GUIで同一の処理パスを使用する統一化
  - [✅] 基本的なセーブ・ロード動作の統一確認
- [✅] **Day 2**: セーブ・ロード機能の完全化
  - [✅] フロアデータの完全復元システム実装
  - [✅] 装備・位置・エンティティ配置の正確な復元
  - [✅] マップ再生成問題の解決
- [ ] **Day 3**: 装備システムの不具合修正
  - [ ] 装備ドロップ時の装備解除処理修正
  - [ ] 装備表示の正確性向上
  - [ ] 動作確認とテスト修正

**Phase 2: 基本機能完成（推定: 1-2日）**
- [ ] **Day 4**: 基本ローグライクコマンドの実装
  - [ ] 🎯 **投げるコマンド（tキー）**（NPCシステム削除によりキーが解放される）
  - [ ] 調査・検査コマンド（xキー）
  - [ ] 長時間休憩コマンド（Rキー）
  - [ ] 走るコマンド（Shift+移動キー）
- [ ] **Day 5**: 品質保証とテスト修正
  - [ ] 統合テストの実効性確保
  - [ ] CLI/GUI動作一致の確認
  - [ ] 最終動作確認

**Phase 3: 次フェーズ準備完了（推定: 1日）**
- [🔄] **Day 6**: 歴史的正確性の改善
  - [🔄] 魔法システムの修正（z = zap wand）
    - [✅] 既存魔法システム（MP、呪文詠唱、Zキー魔法メニュー）の削除
    - [✅] ワンドアイテムクラスの実装
    - [✅] ワンド効果システムの実装
    - [🔄] 方向指定システムの実装（実装中）
  - [✅] オリジナルRogue準拠の調整
  - [🔄] 次期開発フェーズへの準備完了

### 効率的な修正アプローチ

**1. NPCシステム削除による大幅な簡素化**：
- 🗑️ **コードベースの大幅な削減**：NPCクラス、DialogueManager、TradingManager、NPC関連UI等を削除
- 🎯 **tキーの解放**：投げるコマンドが実装可能になる
- 🚀 **テストの簡素化**：NPC関連の複雑なテストケースを削除
- 📦 **依存関係の整理**：NPC関連の複雑な依存関係を除去
- ⚡ **実装速度の向上**：オリジナルRogueに集中できる

**2. 根本原因の集中修正**：
- CLI/GUI統合問題を最優先で解決
- 一度修正すれば、他の多くの問題も連鎖的に解決される

**3. 段階的な動作確認**：
- 各修正後に即座に動作確認
- 問題の早期発見と修正

**4. 実用的な品質保証**：
- CLIテストが実際のGUI動作を反映するように修正
- 統合テストの意味を回復

### 完了後の状況

**推定完了時期**: **4-5日以内**（NPCシステム削除により大幅短縮）

**完了時の状態**：
- 🗑️ **NPCシステム完全削除**：オリジナルRogueに忠実な実装
- ✅ **セーブ・ロード機能が完全に動作**
- ✅ **CLI/GUI間の動作が完全に一致**
- ✅ **基本的なローグライクコマンドが全て実装済み**（投げるコマンド含む）
- ✅ **統合テストが実効性を持つ**
- 🎯 **オリジナルRogue準拠の完全実装**
- 🚀 **次のフェーズ（拡張機能・コンテンツ追加）に進む準備完了**

### 提案：集中開発スプリント

**4-5日の集中開発で問題を一気に解決**し、その後は安心して次のフェーズに進むことができます。NPCシステム削除により：

**🚀 大幅な時間短縮**：
- 元の予定：1週間 → **新しい予定：4-5日**
- NPCシステム削除により2-3日の短縮
- コードベースの大幅な簡素化
- テストケースの削減による効率化

**✅ より確実な実装**：
- オリジナルRogueに忠実な実装
- 複雑な依存関係の除去
- 統合テストの実効性確保
- 投げるコマンドの実装可能化

現在の問題は重大ですが、NPCシステム削除により技術的複雑性が大幅に削減され、より短期間で確実に完了できます。

### 🎯 NPCシステム削除による具体的な改善点

**📦 削除対象のファイル・クラス**：
- `entities/actors/npc.py`
- `entities/actors/npc_spawner.py`
- `ui/screens/dialogue_screen.py`
- `ui/screens/trading_screen.py`
- `core/dialogue_manager.py`
- `core/trading_manager.py`
- NPC関連テストファイル群

**🚀 実装速度の向上**：
- 複雑な依存関係の除去により、セーブ・ロード修正が簡素化
- CLI/GUI統合時のテストケース数の大幅減少
- tキーの投げるコマンドへの転用が即座に可能

**🎯 オリジナルRogue忠実度の向上**：
- 1980年代のRogueには存在しなかった機能の除去
- より純粋なローグライク体験の実現
- 歴史的正確性の大幅な向上

PyRogueは現在、**基本的な機能を持つローグライクゲーム**として動作していますが、**完全なオリジナルRogue体験**を提供するには、上記のアーキテクチャ問題の根本的解決とNPCシステム削除による簡素化が必要です。
