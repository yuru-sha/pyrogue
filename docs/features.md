# PyRogue - 機能一覧

## 概要

PyRogueは、伝統的なローグライクゲームの要素を現代的な技術で実装した完全なゲームシステムです。以下では、実装されている機能を詳細に説明します。

## ゲームプレイ機能

### 1. ダンジョン探索システム

#### 基本機能
- **26階層のダンジョン**: オリジナルRogueに準拠した階層構造
- **手続き生成**: 毎回異なるダンジョンレイアウト
- **部屋とコリドーシステム**: 3×3グリッドベースの部屋配置
- **階段システム**: 上り/下り階段による階層移動

#### 実装場所
- `src/pyrogue/map/dungeon.py` - ダンジョン生成ファサード
- `src/pyrogue/map/dungeon_builder.py` - 生成ロジック
- `src/pyrogue/map/dungeon_manager.py` - マルチフロア管理

#### 詳細仕様
```python
# ダンジョン生成パラメータ
DUNGEON_DEPTH = 26                    # 最大階層数
ROOM_GRID_SIZE = 3                    # 3x3の部屋グリッド
ROOM_MIN_SIZE = 3                     # 最小部屋サイズ
ROOM_MAX_SIZE = 8                     # 最大部屋サイズ
CORRIDOR_WIDTH = 1                    # コリドー幅
HIDDEN_DOOR_CHANCE = 0.15             # 隠し扉の出現確率
```

### 2. 移動・操作システム

#### 基本移動
- **Vi-keys**: hjkl + 対角線移動 (yubn)
- **矢印キー**: 標準的な方向移動
- **テンキー**: 1-9による移動（対角線含む）

#### 操作アクション
- **g**: アイテムの取得
- **o**: 扉を開く
- **c**: 扉を閉じる
- **s**: 隠し扉の探索
- **d**: トラップの解除
- **Tab**: 視界（FOV）表示の切り替え

#### 実装場所
- `src/pyrogue/core/input_handlers.py` - 入力処理
- `src/pyrogue/ui/components/input_handler.py` - UI入力処理
- `src/pyrogue/core/command_handler.py` - 統一コマンド処理

#### コマンド統一化システム
- **共通コマンドハンドラー**: GUIとCLIで統一されたコマンド処理
- **コマンド抽象化**: インターフェース層での統一的な操作
- **キー入力変換**: GUI環境でのキー→コマンド自動変換

### 3. 戦闘システム

#### 基本戦闘
- **ターンベース**: プレイヤー → モンスター → 環境効果
- **近接戦闘**: 隣接するモンスターへの攻撃
- **ダメージ計算**: 攻撃力 - 防御力（最低1ダメージ保証）
- **クリティカルヒット**: 5%確率で2倍ダメージ

#### 実装場所
- `src/pyrogue/core/managers/combat_manager.py` - 戦闘管理
- `src/pyrogue/core/managers/turn_manager.py` - ターン管理

#### 詳細仕様
```python
# 戦闘パラメータ
CRITICAL_HIT_CHANCE = 0.05            # クリティカルヒット確率
CRITICAL_HIT_MULTIPLIER = 2.0         # クリティカルヒット倍率
MIN_DAMAGE = 1                        # 最低ダメージ
BASE_ATTACK_BONUS = 1                 # 基本攻撃ボーナス
```

### 4. 経験値・レベルシステム

#### 成長システム
- **経験値獲得**: モンスター撃破時に獲得
- **レベル差補正**: レベル差による経験値調整
- **能力値成長**: レベルアップ時のHP/MP増加

#### 実装場所
- `src/pyrogue/entities/actors/player.py` - プレイヤー成長
- `src/pyrogue/core/managers/combat_manager.py` - 経験値計算

#### 詳細仕様
```python
# 経験値システム
XP_PER_LEVEL = 100                    # レベルアップ必要経験値
HP_PER_LEVEL = 10                     # レベルアップ時HP増加
MP_PER_LEVEL = 5                      # レベルアップ時MP増加
```

## アイテムシステム

### 1. アイテムカテゴリ

#### 武器 (Weapons)
- **近接武器**: 剣、斧、槍など
- **攻撃力ボーナス**: 基本攻撃力への追加
- **装備システム**: 1つの武器のみ装備可能

#### 防具 (Armor)
- **防御力ボーナス**: 基本防御力への追加
- **重量システム**: 防具の重さによる移動制限
- **装備システム**: 1つの防具のみ装備可能

#### 指輪 (Rings)
- **特殊効果**: 攻撃力、防御力、HP回復など
- **複数装備**: 同時に複数装備可能
- **持続効果**: 装備中は常に効果が適用

#### 消耗品 (Consumables)
- **ポーション**: HP回復、毒回復、能力向上
- **巻物**: 魔法効果、識別、テレポート
- **食料**: 満腹度回復、栄養補給

#### 実装場所
- `src/pyrogue/entities/items/item.py` - アイテム基底クラス
- `src/pyrogue/entities/items/item_types.py` - アイテム種別定義
- `src/pyrogue/entities/items/effects.py` - アイテム効果

### 2. インベントリシステム

#### 管理機能
- **26文字制限**: a-zの文字によるアイテム管理
- **装備管理**: 武器、防具、指輪の装備状態管理
- **重量制限**: 運搬可能重量の制限
- **ソート機能**: アイテムの種類別ソート

#### 操作機能
- **i**: インベントリ画面を開く
- **装備/解除**: 装備可能アイテムの着脱
- **使用**: 消耗品の使用
- **投棄**: 不要なアイテムの投棄

#### 実装場所
- `src/pyrogue/entities/actors/inventory.py` - インベントリ管理
- `src/pyrogue/ui/screens/inventory_screen.py` - インベントリUI

## 魔法システム

### 1. 魔法の種類

#### 攻撃魔法
- **Magic Missile**: 必中の魔法攻撃
- **Poison Bolt**: 毒状態を付与する攻撃魔法

#### 回復魔法
- **Heal**: HP回復魔法
- **Cure Poison**: 毒状態の回復

#### 実装場所
- `src/pyrogue/entities/magic/spells.py` - 魔法システム
- `src/pyrogue/ui/screens/magic_screen.py` - 魔法UI

### 2. 魔法書（Spellbook）システム

#### 管理機能
- **魔法の習得**: 新しい魔法の学習
- **MP管理**: 魔法ポイントの消費と回復
- **詠唱システム**: 魔法の発動処理

#### 操作機能
- **z**: 魔法書を開く
- **矢印キー**: 魔法選択
- **Enter**: 魔法の詠唱
- **a-z**: 魔法の直接選択

#### 詳細仕様
```python
# 魔法システム
MP_RECOVERY_RATE = 0.1                # MP自然回復率
MAGIC_MISSILE_COST = 3                # Magic Missile消費MP
HEAL_COST = 5                         # Heal消費MP
CURE_POISON_COST = 4                  # Cure Poison消費MP
POISON_BOLT_COST = 4                  # Poison Bolt消費MP
```

## 状態異常システム

### 1. 状態異常の種類

#### 毒 (Poison)
- **効果**: 毎ターン継続ダメージ
- **回復**: 時間経過または魔法・アイテムによる回復
- **視覚効果**: 画面表示での状態通知

#### 麻痺 (Paralysis)
- **効果**: 一定ターン行動不能
- **回復**: 時間経過による自動回復
- **戦術的影響**: 戦闘での大きなデメリット

#### 混乱 (Confusion)
- **効果**: 移動方向のランダム化
- **回復**: 時間経過による自動回復
- **戦術的影響**: 意図しない移動による危険

#### 実装場所
- `src/pyrogue/entities/actors/status_effects.py` - 状態異常システム

### 2. 状態異常管理

#### 管理機能
- **複数同時適用**: 異なる状態異常の同時発生
- **持続時間管理**: 各状態異常の残り時間追跡
- **効果の累積**: 同じ状態異常の重複処理

#### 詳細仕様
```python
# 状態異常パラメータ
POISON_DAMAGE = 2                     # 毒ダメージ量
POISON_DURATION = 10                  # 毒持続時間
PARALYSIS_DURATION = 3                # 麻痺持続時間
CONFUSION_DURATION = 5                # 混乱持続時間
```

## トラップシステム

### 1. トラップの種類

#### 落とし穴 (Pit Trap)
- **効果**: 落下ダメージ
- **発見**: 探索コマンドで発見可能
- **回避**: 発見後は回避可能

#### 毒針 (Poison Needle Trap)
- **効果**: 毒状態の付与
- **発見**: 探索コマンドで発見可能
- **解除**: 解除コマンドで無効化可能

#### テレポート (Teleport Trap)
- **効果**: ランダムな場所への移動
- **発見**: 探索コマンドで発見可能
- **回避**: 発見後は回避可能

#### 実装場所
- `src/pyrogue/entities/traps/trap.py` - トラップシステム

### 2. トラップ管理

#### 配置システム
- **確率的配置**: 各フロアでの確率的なトラップ配置
- **隠匿システム**: 初期状態では隠されている
- **発見システム**: 探索コマンドによる発見

#### 詳細仕様
```python
# トラップパラメータ
TRAP_SPAWN_CHANCE = 0.05              # トラップ出現確率
PIT_TRAP_DAMAGE = 10                  # 落とし穴ダメージ
DISARM_SUCCESS_RATE = 0.7             # 解除成功率
SEARCH_SUCCESS_RATE = 0.6             # 探索成功率
```

## UIシステム

### 1. 画面システム

#### メイン画面
- **ゲーム表示**: マップ、キャラクター、アイテムの表示
- **ステータス表示**: HP、MP、レベル、経験値
- **メッセージ表示**: ゲームイベントのメッセージ

#### メニュー画面
- **New Game**: 新しいゲームの開始
- **Load Game**: セーブデータの読み込み
- **Exit**: ゲーム終了

#### 実装場所
- `src/pyrogue/ui/screens/` - 各種画面システム
- `src/pyrogue/ui/components/` - UI コンポーネント

### 2. 視界システム (FOV)

#### 機能
- **視界計算**: プレイヤーの視界範囲計算
- **光源システム**: 光源による視界の変化
- **霧システム**: 未探索・既探索領域の区別

#### 実装場所
- `src/pyrogue/ui/components/fov_manager.py` - 視界管理

## セーブ・ロードシステム

### 1. セーブ機能

#### 保存データ
- **プレイヤー状態**: HP、MP、レベル、装備、インベントリ
- **ダンジョン状態**: 各フロアの状態、モンスター位置
- **ゲーム進行**: 現在フロア、ゲーム時間、スコア

#### 操作
- **Ctrl+S**: 現在の状態をセーブ
- **自動セーブ**: 重要なイベント時の自動保存

#### 実装場所
- `src/pyrogue/core/save_manager.py` - セーブ・ロード管理
- `src/pyrogue/ui/components/save_load_manager.py` - UI連携

### 2. ロード機能

#### 復元データ
- **完全復元**: セーブ時点の状態を完全に復元
- **整合性チェック**: データの整合性確認
- **エラーハンドリング**: 破損データの適切な処理

#### 操作
- **Ctrl+L**: セーブデータの読み込み
- **メニューから選択**: メイン画面からのロード

## モンスターシステム

### 1. AI システム

#### 行動パターン
- **追跡**: プレイヤーの位置に向かって移動
- **攻撃**: 隣接時の攻撃行動
- **待機**: 発見前の待機状態

#### 実装場所
- `src/pyrogue/core/managers/monster_ai_manager.py` - モンスターAI管理
- `src/pyrogue/entities/actors/monster.py` - モンスター基底クラス

### 2. モンスター種別

#### 基本モンスター
- **多様な種類**: A-Zの文字で表現される26種類
- **能力値**: 各モンスター固有の HP、攻撃力、防御力
- **特殊能力**: 一部モンスターの特殊攻撃

#### 実装場所
- `src/pyrogue/entities/actors/monster_types.py` - モンスター定義
- `src/pyrogue/entities/actors/monster_spawner.py` - モンスター生成

## 設定・カスタマイズ

### 1. ゲーム設定

#### パラメータ調整
- **難易度設定**: モンスター出現率、ダメージ倍率
- **表示設定**: 色彩、フォントサイズ
- **操作設定**: キーバインドのカスタマイズ

#### 実装場所
- `src/pyrogue/config.py` - 設定管理（非推奨）
- `src/pyrogue/constants.py` - 定数管理（推奨）

### 2. デバッグ機能

#### 開発支援
- **デバッグモード**: 詳細情報の表示
- **チート機能**: 無敵モード、アイテム生成
- **ログ出力**: 詳細なゲーム状態ログ

#### 実装場所
- `src/pyrogue/utils/logger.py` - ログシステム
- `src/pyrogue/core/cli_engine.py` - CLI開発モード

#### CLIモード詳細
```bash
# CLIモードでの起動
python -m pyrogue.main --cli

# 利用可能なコマンド例
> move north    # 北へ移動
> get           # アイテム取得
> use potion    # ポーション使用
> attack        # 攻撃
> status        # ステータス表示
> quit          # ゲーム終了
```

**特徴**:
- **統一コマンドセット**: GUIと同じ操作がテキストで可能
- **自動化対応**: スクリプトによる自動テスト
- **開発効率**: デバッグとテストの高速化

## 今後の拡張予定

### 1. 予定機能

#### NPCシステム
- **商人**: アイテムの売買
- **クエスト**: 特定の任務システム
- **会話**: NPCとの対話システム

#### 追加コンテンツ
- **新魔法**: 追加の魔法種類
- **新アイテム**: 特殊効果のアイテム
- **新モンスター**: 特殊能力を持つモンスター

### 2. 技術的改善

#### 性能向上
- **描画最適化**: 差分描画の改善
- **メモリ効率**: データ構造の最適化
- **並列処理**: マルチスレッド対応

#### 機能拡張
- **サウンド**: 効果音・BGM
- **グラフィック**: タイルベース表示
- **ネットワーク**: マルチプレイヤー対応

## まとめ

PyRogueは、伝統的なローグライクゲームの要素を現代的な技術で実装した包括的なゲームシステムです。完成度の高い機能群により、本格的なローグライクゲーム体験を提供するとともに、拡張性の高い設計により継続的な機能追加が可能です。

各機能は独立性を保ちながら有機的に連携し、一貫性のあるゲーム体験を実現しています。また、包括的なテストとドキュメントにより、高い品質と保守性を確保しています。
